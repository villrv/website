<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>moo | V. Ashley Villar</title> <meta name="author" content="V. Ashley Villar"> <meta name="description" content="fitting models with moo"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/al-folio/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/al-folio/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/al-folio/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/al-folio/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ashleyvillar.com/al-folio/blog/2017/Fitting-Models-with-Moo/"> <link rel="stylesheet" href="/al-folio/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/al-folio/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/al-folio/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/al-folio/">V. <span class="font-weight-bold">Ashley </span>Villar</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/al-folio/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/al-folio/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/al-folio/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/al-folio/data/">data</a> </li> <li class="nav-item "> <a class="nav-link" href="/al-folio/dlps/">dlps</a> </li> <li class="nav-item "> <a class="nav-link" href="/al-folio/teaching/">teaching</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">moo</h1> <p class="post-meta">April 23, 2017</p> <p class="post-tags"> <a href="/al-folio/blog/2017"> <i class="fas fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/al-folio/blog/tag/astronomy"> <i class="fas fa-hashtag fa-sm"></i> astronomy,</a>   <a href="/al-folio/blog/tag/guide"> <i class="fas fa-hashtag fa-sm"></i> guide</a>     ·   <a href="/al-folio/blog/category/guide"> <i class="fas fa-tag fa-sm"></i> guide</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This post summarizes a lecture I have given several times to undergrads and early graduate students on model fitting. I will (hopefully) highlight the flexibility of the fitting process and a simple guide to work through most problems. I’m going to assume a basic understanding of the statistics involved, and my example problem will be in Python.</p> <h2 id="using-moo-">Using MOO <img src="/images/april2017/april2017_cow.png" alt="cow" style="width: 50px;"> </h2> <p>Imagine I give you a dataset and I ask you to fit a model to it. This might be a supernova light curve, a stellar spectrum or a galaxy rotation model. Whatever problem you’re facing, we can break it down into <strong>MOO</strong>:</p> <ol> <li> <em><strong>M</strong>odel</em> which you need to choose to fit to the data!</li> <li> <em><strong>O</strong>jective Function</em> which is a metric that you will choose to quantify how <em>well</em> the model fits the data.</li> <li> <em><strong>O</strong>ptimization Method</em> which you will use to pick the <em>best</em> model.</li> </ol> <p>We’re going to break down each step using a simple astronomical example. For each step, I’ll provide code to solve the problem in a few ways, so I encourage you to mix-and-match!</p> <h2 id="the-model">The Model</h2> <p>Let’s start with an example <strong>model</strong> and dataset to fit. In astronomy, a common problem is to fit Gaussian-like models to <a href="https://en.wikipedia.org/wiki/Spectral_line" rel="external nofollow noopener" target="_blank">spectral lines</a>. These models typically have three parameters: height, width and central wavelength. You can play with two models in this example: the Lorentzian and the Gaussian. The Lorentzian profile looks like:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">((</span><span class="n">lam</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div> <p>and the Gaussian profile is:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">my_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">height</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">lam</span> <span class="o">-</span> <span class="n">center</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">width</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div> <p>Choose the <em>right</em> model can be very challenging. In many cases, the model will be physically motivated. For example, we can think of a physical model to describe the light curve of a transiting planet. Other times, our models are <em>data-driven</em>. For example, the famous <a href="https://en.wikipedia.org/wiki/M%E2%80%93sigma_relation" rel="external nofollow noopener" target="_blank">M-sigma relation</a> relates the stellar velocity dispersion of a galaxy bulge with the mass of its supermassive black hole. The physical basis of this relation is uncertain, but we can see that a linear model connects the two galactic features.</p> <p>Back to our problem: I am going to generate some fake data which we can fit our model to by adding white ( uncorrelated) noise:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">my_lam</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">6400</span><span class="p">,</span><span class="mi">6700</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">NOISE</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">my_data</span> <span class="o">=</span> <span class="nf">my_model</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="mi">6563</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">NOISE</span><span class="p">,</span><span class="nf">len</span><span class="p">(</span><span class="n">my_lam</span><span class="p">))</span>
<span class="n">my_sigmas</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">my_lam</span><span class="p">))</span> <span class="o">+</span> <span class="n">NOISE</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="sh">'</span><span class="s">$\lambda$</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Flux</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">Beautiful Data</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <p><img src="/images/april2017/banneker_3_0.png" alt="png"></p> <p>Our spectral line has a <em>true</em> height of 100 flux units, a width of 20 Angstrom and a central wavelength of 6563 Angstrom. You can play with the <code class="language-plaintext highlighter-rouge">NOISE</code> parameter to change the signal-to-noise of the data. Try setting it to something very large, like <code class="language-plaintext highlighter-rouge">NOISE = 50</code>!</p> <h2 id="the-objective-function">The Objective Function</h2> <p>Now that we have our models (and some data!), let’s choose a <strong>metric</strong> to quantify how <em>well</em> our model fits our dataset. This metric has many names: objective function, cost function, loss function, utility function, etc. (I called it an <strong>objective function</strong> so I could draw a cow.) The metric that most people are familiar with is called <strong>chi-squared</strong>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">metric_chi2</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sigmas</span><span class="p">):</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">((</span><span class="nf">my_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">)</span><span class="o">-</span><span class="n">data</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">sigmas</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div> <p>Remember that we want to <em>minimize</em> chi-squared values to choose the best model. Chi-squared assumes that our noise is uncorrelated and Gaussian, which is true in many cases. But we can easily choose other objective functions:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">metric_residuals</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sigmas</span><span class="p">):</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="nf">my_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">)</span><span class="o">-</span><span class="n">data</span><span class="p">))</span>
</code></pre></div></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">metric_log_likelihood</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">lam</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">sigmas</span><span class="p">):</span>
    <span class="n">center</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">((</span><span class="n">data</span><span class="o">-</span><span class="nf">my_model</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span><span class="n">center</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">width</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">sigmas</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="n">sigmas</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
</code></pre></div></div> <p><code class="language-plaintext highlighter-rouge">metric_residuals</code> computes the sum of the absolute values of the residuals of our model, and <code class="language-plaintext highlighter-rouge">metric_log_likelihood</code> computes the log likelihood of our model. Remember that we want to <em>maximize</em> the log likelihood, but we want to <em>minimize</em> sums of residuals.</p> <h2 id="the-optimization-method">The Optimization Method</h2> <p>Finally, let’s fit our data by choosing an <em>optimization method</em> to optimize our <em>objective function</em>. We’re going to start with the easiest thing we can think of and work our way up. First, let’s literally just pick random values for the height, width and center of our spectral line. We’ll choose values 50 times, and the <em>best</em> model will be our winner. this is called a <em>random grid search</em>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">center_choices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">6500</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">6600</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">height_choices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">width_choices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="n">lowest_chi</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span>
<span class="n">best_c</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_h</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">best_w</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">center_choices</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">height_choices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">width_choices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">w</span><span class="p">]</span>

    <span class="n">current_chi</span> <span class="o">=</span> <span class="nf">metric_log_likelihood</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">,</span><span class="n">my_sigmas</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">current_chi</span> <span class="o">&lt;</span> <span class="n">lowest_chi</span><span class="p">:</span>
        <span class="n">best_c</span> <span class="o">=</span> <span class="n">c</span>
        <span class="n">best_h</span> <span class="o">=</span> <span class="n">h</span>
        <span class="n">best_w</span> <span class="o">=</span> <span class="n">w</span>
        <span class="n">lowest_chi</span> <span class="o">=</span> <span class="n">current_chi</span>

<span class="k">print</span> <span class="sh">"</span><span class="s">Chi2</span><span class="sh">"</span><span class="p">,</span><span class="n">lowest_chi</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">my_lam</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="nf">my_model</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">best_c</span><span class="p">,</span><span class="n">best_h</span><span class="p">,</span><span class="n">best_w</span><span class="p">))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chi2 2.89601950512
</code></pre></div></div> <p><img src="/images/april2017/banneker_6_1.png" alt="png"></p> <p>Our reduced chi-squared is about 3, which is pretty bad. Let’s try to do better! We will use <code class="language-plaintext highlighter-rouge">scipy</code>’s <code class="language-plaintext highlighter-rouge">minimize</code> function, which uses a form of <em>gradient descent</em> to minimize the objective function:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6560</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">bnds</span> <span class="o">=</span> <span class="p">((</span><span class="mi">6500</span><span class="p">,</span> <span class="mi">6650</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">None</span><span class="p">),(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">))</span>
<span class="n">res</span> <span class="o">=</span> <span class="nf">minimize</span><span class="p">(</span><span class="n">metric_log_likelihood</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">p0</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">,</span><span class="n">my_sigmas</span><span class="p">),</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="sh">'</span><span class="s">gtol</span><span class="sh">'</span><span class="p">:</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="sh">'</span><span class="s">disp</span><span class="sh">'</span><span class="p">:</span> <span class="bp">True</span><span class="p">},</span><span class="n">bounds</span><span class="o">=</span><span class="n">bnds</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="nf">my_model</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span><span class="n">res</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">res</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">res</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
<span class="k">print</span> <span class="sh">"</span><span class="s">Chi2</span><span class="sh">"</span><span class="p">,</span><span class="nf">metric_chi2</span><span class="p">(</span><span class="n">res</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="n">my_lam</span><span class="p">,</span><span class="n">my_data</span><span class="p">,</span><span class="n">my_sigmas</span><span class="p">)</span><span class="o">/</span><span class="nf">len</span><span class="p">(</span><span class="n">my_lam</span><span class="p">)</span>
</code></pre></div></div> <p><img src="/images/april2017/banneker_8_0.png" alt="png"></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Chi2 1.02930073003
</code></pre></div></div> <p>Great! Our reduced chi-squared value is about 1, which means that we’ve found a good fit to the data. Play around with combining different <em>objective functions</em> and <em>optimization methods</em>. Is there any metric which seems to work best for this problem?</p> <p>Unfortunately, we do not have error estimates on our models using these optimization methods with the code provided. We can use an even fancier optimization technique called a <a href="https://jeremykun.com/2015/04/06/markov-chain-monte-carlo-without-all-the-bullshit/" rel="external nofollow noopener" target="_blank">Markov-Chain Monte Carlo</a> to estimate the best-fit model <em>and</em> error bars on the model parameters by sampling from our likelihood function. We’ll use the popular <a href="http://dan.iel.fm/emcee/current/" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">emcee</code></a>:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ndim</span><span class="p">,</span> <span class="n">nwalkers</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">100</span>
<span class="n">p0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6560</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">5</span><span class="p">]</span>
<span class="n">pos</span> <span class="o">=</span> <span class="p">[</span><span class="n">p0</span> <span class="o">+</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">)]</span>

<span class="n">sampler</span> <span class="o">=</span> <span class="n">emcee</span><span class="p">.</span><span class="nc">EnsembleSampler</span><span class="p">(</span><span class="n">nwalkers</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">metric_log_likelihood</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">my_lam</span><span class="p">,</span> <span class="n">my_data</span><span class="p">,</span> <span class="n">my_sigmas</span><span class="p">))</span>
<span class="n">sampler</span><span class="p">.</span><span class="nf">run_mcmc</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">samples</span> <span class="o">=</span> <span class="n">sampler</span><span class="p">.</span><span class="n">chain</span><span class="p">[:,</span> <span class="mi">500</span><span class="p">:,</span> <span class="p">:].</span><span class="nf">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndim</span><span class="p">))</span>
<span class="n">corner</span><span class="p">.</span><span class="nf">corner</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">center</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">height</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">width</span><span class="sh">"</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">xlabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Iteration Number</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">ylabel</span><span class="p">(</span><span class="sh">'</span><span class="s">Height</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="sh">'</span><span class="s">A Sample Chain</span><span class="sh">'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>

<span class="k">print</span> <span class="sh">"</span><span class="s">CENTER</span><span class="sh">"</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">84</span><span class="p">])</span>
<span class="k">print</span> <span class="sh">"</span><span class="s">HEIGHT</span><span class="sh">"</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">84</span><span class="p">])</span>
<span class="k">print</span> <span class="sh">"</span><span class="s">WIDTH</span><span class="sh">"</span><span class="p">,</span><span class="n">np</span><span class="p">.</span><span class="nf">percentile</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">16</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span><span class="mi">84</span><span class="p">])</span>

</code></pre></div></div> <p><img src="/images/april2017/banneker_9_0.png" alt="png"></p> <p><img src="/images/april2017/banneker_9_1.png" alt="png"></p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CENTER [ 6562.78917939  6562.96188268  6563.14312425]
HEIGHT [ 100.46597986  102.28547484  103.99994744]
WIDTH [ 19.37125165  19.84305208  20.3369578 ]
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">corner</code> plot shows the best-fit parameter posterior distributions (assuming uniform priors), which we have used to estimate both the best-fit values and the 1-sigma error bars. Below this plot is a sample chain from the MCMC that shows a walker traversing through the posterior.</p> <p>Try adding a nonuniform prior to the <em>objective function</em>. Does the MCMC produce different results?</p> <h2 id="conclusion">Conclusion</h2> <p>We fit our model! Again, I highly recommend switching out the <strong>MOO</strong> components for this example and understanding what effects this has on your final model. Each component of <strong>MOO</strong> has special considerations, but it’s important to remember that <em>you</em> have the power to change each step to fit your needs!</p> <p>So what should you do when faced with real data? My biggest recommendation to new researchers is to do the <em>easiest</em> thing first. Choose a simple model, objective function and optimization function. For example, I typically begin model fits by minimizing chi-squared with <code class="language-plaintext highlighter-rouge">minimizer</code>.</p> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 V. Ashley Villar. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/al-folio/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/al-folio/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/al-folio/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/al-folio/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/al-folio/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/al-folio/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>